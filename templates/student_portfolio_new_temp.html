{% extends "base.html" %}
{% from "macros.html" import criteria_display_score, display_single_score %}
{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chart-styles.css') }}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

{{ super() }}
<style>
    /* Custom styles for portfolio page */
    .portfolio-header {
        background-color: #f0f8ff;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;student.first_name
        border-left: 5px solid #007bff;
    }
    /* Keep all existing styles... */
    .stat-card {
        background-color: #fff;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        height: 100%;
        transition: transform 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #007bff;
    }

    .stat-label {
        font-size: 0.9rem;
        color: #6c757d;
    }

    .writing-card {
        background-color: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        border-left: 5px solid #28a745;
    }

    .chart-container {
        position: relative;
        margin: auto;
        height: 300px;
        width: 100%;
    }

    .toggle-chart-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
    }

    .criteria-pill {
        display: inline-block;
        padding: 5px 10px;
        margin: 3px;
        border-radius: 20px;
        font-size: 0.8rem;
    }

    .criteria-met {
        background-color: #d4edda;
        color: #155724;
    }

    .criteria-partial {
        background-color: #fff3cd;
        color: #856404;
    }

    .criteria-not-met {
        background-color: #f8d7da;
        color: #721c24;
    }

    .student-nav {
        margin: 20px 0;
    }

    /* Text highlighting styles */
    .highlight-vocabulary {
        background-color: #c6f6d5;
    }

    .highlight-grammar {
        background-color: #bee3f8;
    }

    .highlight-structure {
        background-color: #fed7d7;
    }

    .highlight-punctuation {
        background-color: #fefcbf;
    }

    .text-content {
        white-space: pre-wrap;
        line-height: 1.8;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        background-color: #f8f9fa;
        font-family: 'Roboto', sans-serif;
    }

    .criteria-legend {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 10px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        margin-right: 15px;
        margin-bottom: 5px;
    }

    .legend-color {
        width: 20px;
        height: 20px;
        margin-right: 5px;
        border-radius: 3px;
    }

    .criteria-score-container {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 10px;
    }

    .loading-animation {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 300px;
    }

    .spinner-border {
        width: 3rem;
        height: 3rem;
    }

    .btn-fab {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        position: fixed;
        bottom: 30px;
        right: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        z-index: 1000;
    }

    .portfolio-stats {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .stats-heading {
        font-size: 1.2rem;
        color: #495057;
        margin-bottom: 15px;
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
    }

    .chart-toggle-container {
        position: relative;
        text-align: right;
        margin-bottom: 10px;
    }

    .toggle-details {
        cursor: pointer;
    }

    .details-row {
        background-color: #f8f9fa;
    }

    .marking-instructions {
        background-color: #e9ecef;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                {% if student %}
                    <h1 class="mb-0">{{ student.first_name }}'s Portfolio</h1>
                {% else %}
                    <h1>Error: student not found in context</h1>
                {% endif %}

                <div class="student-nav">

                    <div class="btn-group" role="group">
                        {% if prev_student %}
                        <a href="{{ request.url_for('student_portfolio', student_id=prev_student.id) }}" class="btn btn-outline-primary">
                            <i class="fas fa-chevron-left"></i> Previous: {{ prev_student.first_name }}
                        </a>
                        {% endif %}

                        {% if next_student %}
                        <a href="{{ request.url_for('student_portfolio', student_id=next_student.id) }}" class="btn btn-outline-primary">
                            Next: {{ next_student.first_name }} <i class="fas fa-chevron-right"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% with flash = request.session.pop("flash", None) %}
                {% if flash %}
                    <div id='toast' class="alert alert-{{ flash.category }}">{{ flash.message }}</div>
                {% endif %}
            {% endwith %}


            <div class="portfolio-header">
                <div class="row">
                    <div class="col-md-6">
                        <h4 class="mb-2">{{ student.first_name }} {{ student.last_name }}</h4>
                        <p class="mb-1">
                            <i class="fas fa-graduation-cap me-2"></i> Class: {{ student.class_group.name if student.class_group else 'N/A' }}

                        </p>
                        <p class="mb-1">
                            <i class="fas fa-calendar-alt me-2"></i> Date of Birth: {{ student.date_of_birth.strftime('%d %b %Y') }}
                        </p>
                        {% if student.student_id %}
                        <p class="mb-1">
                            <i class="fas fa-id-card me-2"></i> Student ID: {{ student.student_id }}
                        </p>
                        {% endif %}
                    </div>
                    <div class="col-md-6 text-md-end">
                        <div class="btn-group">
                            <a href="{{ request.url_for('export_student_portfolio', student_id=student.id) }}" class="btn btn-outline-success">
                                <i class="fas fa-file-excel me-1"></i> Export Portfolio
                            </a>
                            <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteStudentModal">
                                <i class="fas fa-trash-alt me-1"></i> Delete Student
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="portfolio-stats">
                <h5 class="stats-heading">Portfolio Overview</h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="row">
                                <div class="col-8">
                                    <div class="stat-number">{{ writing_samples|length }}</div>
                                    <div class="stat-label">Writing Samples</div>
                                </div>
                                <div class="col-4 text-end">
                                    <i class="fas fa-file-alt fa-2x text-primary"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="row">
                                <div class="col-8">
                                    <div class="stat-number">{{ assignments|length }}</div>
                                    <div class="stat-label">Assignments</div>
                                </div>
                                <div class="col-4 text-end">
                                    <i class="fas fa-tasks fa-2x text-success"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="row">
                                <div class="col-8">
                                    <div class="stat-number">
                                        {% if average_criteria_met is not none %}
                                        {{ '%.1f'|format(average_criteria_met) }}%
                                        {% else %}
                                        -
                                        {% endif %}
                                    </div>
                                    <div class="stat-label">Avg. Criteria Met</div>
                                </div>
                                <div class="col-4 text-end">
                                    <i class="fas fa-check-circle fa-2x text-info"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="row">
                                <div class="col-8">
                                    <div class="stat-number">
                                        {% if progress_rating %}
                                        {{ progress_rating }}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </div>
                                    <div class="stat-label">
                                        Progress Rating
                                        <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" title="Based on recent writing samples' age compared to actual age."></i>
                                    </div>

                                </div>
                                <div class="col-4 text-end">
                                    <i class="fas fa-chart-line fa-2x text-warning"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Writing Samples</h5>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 5%">#</th>
                                    <th style="width: 15%">Date</th>
                                    <th style="width: 20%">Filename</th>
                                    <th style="width: 20%">Assignment</th>
                                    <th style="width: 15%">Writing Age</th>
                                    <th style="width: 15%">Marks (%)</th>
                                    <th style="width: 10%">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sample in writing_samples %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ sample.created_at.strftime('%d %b %Y') }}</td>
                                    <td>
                                        <form id="filename-form-{{ sample.id }}" class="d-flex align-items-center" method="POST" action="{{ url_for('update_writing_filename', writing_id=sample.id) }}">
                                            <input type="text" name="filename" class="form-control form-control-sm" value="{{ sample.filename }}" onblur="this.form.submit()" style="width: 85%;">
                                            <i class="fas fa-edit ms-2 text-muted" style="font-size: 0.8rem;"></i>
                                        </form>
                                    </td>
                                    <td>
                                        {% if sample.assignment %}
                                        <span class="badge bg-primary">{{ sample.assignment.title }}</span>
                                        {% else %}
                                        <span class="badge bg-secondary">No Assignment</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ sample.writing_age }}</td>
                                    <td>
                                        {% if sample.criteria_marks and sample.criteria_marks|length > 0 %}
                                            {% set total_criteria = sample.criteria_marks|length %}
                                            {% set criteria_met = 0 %}
                                            {% set criteria_partial = 0 %}

                                            {% for mark in sample.criteria_marks %}
                                                {% if mark.score == 2 %}
                                                    {% set criteria_met = criteria_met + 1 %}
                                                {% elif mark.score == 1 %}
                                                    {% set criteria_partial = criteria_partial + 1 %}
                                                {% endif %}
                                            {% endfor %}

                                            {% if total_criteria > 0 %}
                                                {% if sample.total_marks_percentage %}
                                                    <div class="d-flex align-items-center">
                                                        <div class="h3 mb-0">{{ sample.total_marks_percentage | round(1) }}%</div>
                                                    </div>
                                                {% else %}
                                                    {% set met_percent = (criteria_met / total_criteria * 100) | round(1) %}
                                                    {% set partial_percent = (criteria_partial / total_criteria * 100) | round(1) %}
                                                    {% set total_mark = (met_percent + (partial_percent / 2)) | round(1) %}

                                                    <div class="d-flex align-items-center">
                                                        <div class="h3 mb-0">{{ total_mark }}%</div>
                                                    </div>
                                                {% endif %}
                                            {% else %}
                                                <div class="text-muted">No criteria</div>
                                            {% endif %}
                                        {% else %}
                                            <div class="text-muted">No marks</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary" onclick="toggleDetails('{{ sample.id }}')">
                                                <i id="icon-{{ sample.id }}" class="fas fa-chevron-down"></i>
                                            </button>
                                            <a href="/writing/{{ sample.id }}/delete" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete \"{{ sample.filename }}\"? This action cannot be undone.')">
                                                <i class="fas fa-trash-alt"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                <tr id="details-row-{{ sample.id }}" class="details-row" style="display: none;">
                                    <td colspan="7" class="p-3">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="card mb-3">
                                                    <div class="card-header bg-info text-white">
                                                        <h6 class="mb-0">Writing Analysis</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <p class="mb-2"><strong>Writing Age:</strong> {{ sample.writing_age }}</p>
                                                        {% if age_differences %}
                                                            {% for diff in age_differences %}
                                                                {% if diff.sample_id == sample.id %}
                                                                    <p class="mb-2"><strong>Compared to Actual Age:</strong> 
                                                                        {% if diff.difference >= 0 %}
                                                                            <span class="text-success">+{{ diff.difference }} years above age level</span>
                                                                        {% else %}
                                                                            <span class="text-danger">{{ diff.difference }} years below age level</span>
                                                                        {% endif %}
                                                                    </p>
                                                                {% endif %}
                                                            {% endfor %}
                                                        {% endif %}

                                                        <hr>

                                                        <h6>Feedback:</h6>
                                                        <div class="feedback-content">
                                                            {{ sample.feedback|nl2br|safe if sample.feedback else 'No feedback available' }}
                                                        </div>

                                                        <div class="mt-3">
                                                            <a href="{{ url_for('print_writing_report', writing_id=sample.id) }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                                <i class="fas fa-print me-1"></i> Print Report
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-8">
                                                <div class="card">
                                                    <div class="card-header bg-success text-white">
                                                        <h6 class="mb-0">Writing Sample</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="text-content">{{ sample.text_content }}</div>

                                                        {% if sample.assignment and sample.criteria_marks %}
                                                            <hr>
                                                            <h6 class="mt-3">Assessment Criteria:</h6>

                                                            <div class="criteria-legend">
                                                                <div class="legend-item">
                                                                    <div class="legend-color" style="background-color: #d4edda;"></div>
                                                                    <span>Confidently Used</span>
                                                                </div>
                                                                <div class="legend-item">
                                                                    <div class="legend-color" style="background-color: #fff3cd;"></div>
                                                                    <span>Partially Met</span>
                                                                </div>
                                                                <div class="legend-item">
                                                                    <div class="legend-color" style="background-color: #f8d7da;"></div>
                                                                    <span>Not Met</span>
                                                                </div>
                                                            </div>

                                                            <div class="table-responsive">
                                                                <table class="table table-sm">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>Criteria</th>
                                                                            <th>Score</th>
                                                                            <th>Justification</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        {% for mark in sample.criteria_marks %}
                                                                            <tr>
                                                                                <td>{{ mark.criteria.description }}</td>
                                                                                <td>{{ display_single_score(mark.score) }}</td>
                                                                                <td>{{ mark.justification }}</td>
                                                                            </tr>
                                                                        {% endfor %}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Student Deletion -->
<div class="modal fade" id="deleteStudentModal" tabindex="-1" aria-labelledby="deleteStudentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteStudentModalLabel">Delete Student</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong>{{ student.first_name }} {{ student.last_name }}</strong>?</p>
                <p>This will permanently delete all of this student's writing samples, assessment data, and other records. This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="{{ url_for('delete_student', student_id=student.id) }}" class="btn btn-danger">Delete Student</a>
            </div>
        </div>
    </div>
</div>

<!-- Add direct script for toggle functionality -->
<script>
function toggleDetails(sampleId) {
    var detailsRow = document.getElementById('details-row-' + sampleId);
    var icon = document.getElementById('icon-' + sampleId);
    
    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = 'table-row';
        icon.className = 'fas fa-chevron-up';
    } else {
        detailsRow.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
    }
}
</script>

<script>
  var element = document.getElementById('toast');
  element.style.display = "block";
  setTimeout(function() {
    element.style.display = "none";
  }, 3000); // 1000ms = 1 second
</script>

{% endblock %}

{% block scripts %}
{{ super() }}
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script src="{{ url_for('static', filename='js/portfolio_charts.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
{% endblock %}