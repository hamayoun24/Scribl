<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classes - Text Analysis</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    <style>
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .table th {
            position: sticky;
            top: 0;
            background-color: var(--bs-dark);
            z-index: 1;
        }
    </style>
</head>
<body>
{% extends "base.html" %}
{% block content %}
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="mb-0">Classes</h1>
                    <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addClassModal">
                        <i class="fa fa-plus me-2"></i>Add Class
                    </button>
                </div>
                    {% with flash = request.session.pop("flash", None) %}
                        {% if flash %}
                            <div id='toast' class="alert alert-{{ flash.category }}">{{ flash.message }}</div>
                        {% endif %}
                    {% endwith %}

            
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}


                {% if classes %}
                    {% for class in classes %}
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">{{ class.name }} ({{ class.year_group }})</h5>
                                <div class="btn-group">
                                    <button class="btn btn-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#addStudentModal" onclick="setClassId({{ class.id }})">
                                        <i class="fa fa-plus me-1"></i>Add Student
                                    </button>
                                    <a href="{{ url_for('export_class_overview', class_id=class.id) }}" 
                                       class="btn btn-outline-primary btn-sm me-2">
                                        <i class="fa fa-download me-1"></i>Export Data
                                    </a>
                                    <button class="btn btn-sm btn-outline-danger"
                                            onclick="deleteClass({{ class.id }}, '{{ class.name }}')">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                {% if class.students %}
                                    <!-- Performance Graphs -->
                                    <div class="graphs mb-4">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h5>Class Performance</h5>
                                            <div class="chart-toggle">
                                                <button type="button" class="active" data-graph="marks{{ class.id }}">Marks by Genre</button>
                                                <button type="button" data-graph="age{{ class.id }}">Writing Age</button>
                                            </div>
                                        </div>
                                        <div class="chart-container" style="height: 300px;">
                                            <canvas id="marksChart{{ class.id }}"></canvas>
                                            <canvas id="ageChart{{ class.id }}" style="display: none;"></canvas>
                                        </div>
                                    </div>

                                    <div class="table-container">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>First Name</th>
                                                    <th>Last Name</th>
                                                    <th>Student ID</th>
                                                    <th>Date of Birth</th>
                                                    <th>Recent Writing Age</th>
                                                    <th>Average Mark</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for student in class.students %}
                                                <tr>
                                                    <td>{{ student.first_name }}</td>
                                                    <td>{{ student.last_name }}</td>
                                                    <td>
                                                        {% if student.student_id %}
                                                            {{ student.student_id }}
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ student.date_of_birth.strftime('%d/%m/%Y') }}</td>
                                                    <td>
                                                        {% if student.writing_samples %}
                                                            {% set latest = student.writing_samples|sort(attribute='created_at')|last %}
                                                            {{ latest.writing_age }}
                                                        {% else %}
                                                            No samples
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if student.writing_samples %}
                                                            {% set marks = [] %}
                                                        {% for sample in student.writing_samples %}
                                                            {% if sample.criteria_marks %}
                                                                {% set total = sample.criteria_marks|length * 2 %}
                                                                {% set achieved = sample.criteria_marks|sum(attribute='score') %}
                                                                {% if total > 0 %}
                                                                    {% set _ = marks.append((achieved / total * 100)) %}
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endfor %}
                                                        {% set avg_mark = marks|mean if marks else 0 %}
                                                            {{ "%.1f"|format(avg_mark) }}%
                                                        {% else %}
                                                            No marks
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <div class="btn-group">
                                                            <a href="{{ url_for('student_portfolio', student_id=student.id) }}" 
                                                               class="btn btn-outline-primary btn-sm">
                                                                <i class="fa fa-folder-open me-1"></i>View Portfolio
                                                            </a>
                                                            <button class="btn btn-outline-danger btn-sm"
                                                                    onclick="deleteStudent({{ student.id }}, '{{ student.name }}')">
                                                                <i class="fa fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <p class="text-muted mb-0">No students added yet.</p>
                                {% endif %}

                                <!-- CSV upload section -->
                                <div class="mt-3">
                                    <div class="form-text mb-3">
                                        Upload a CSV file with student details:
                                        <br>Format: Student ID (optional), First Name, Last Name, Date of Birth (YYYY-MM-DD)
                                        <a href="#" class="download-template d-block mt-2" data-class-id="{{ class.id }}">
                                            <i class="fa fa-download"></i> Download Template
                                        </a>
                                    </div>
                                    <form action="{{ url_for('upload_students') }}" method="post" enctype="multipart/form-data" id="csvUploadForm">
                                        <input type="hidden" name="class_id" value="{{ class.id }}">
                                        <div class="input-group">
                                            <input type="file" class="form-control" name="file" accept=".csv" required style="background-color: white; color: #0d6efd; border-color: #dee2e6;">
                                            <button type="submit" class="btn btn-primary">Upload</button>
                                        </div>
                                    </form>
                                </div>

                                <script>
                                    document.getElementById('csvUploadForm').addEventListener('submit', function(e) {
                                        const fileInput = this.querySelector('input[type="file"]');
                                        if (fileInput.files.length > 0) {
                                            const file = fileInput.files[0];
                                            if (!file.name.toLowerCase().endsWith('.csv')) {
                                                e.preventDefault();
                                                alert('Please upload a CSV file');
                                                return false;
                                            }
                                        }
                                    });
                                </script>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">
                        <i class="fa fa-info-circle me-2"></i>You haven't created any classes yet.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{{ url_for('add_student') }}">
                        <input type="hidden" name="class_id" id="studentClassId">

                        <div class="mb-3">
                            <label for="student_id" class="form-label">Student ID</label>
                            <input type="text" class="form-control" id="student_id" name="student_id" value="{{ student_form.student_id or '' }}" placeholder="Optional">
                        </div>

                        <div class="mb-3">
                            <label for="first_name" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="first_name" name="first_name" value="{{ student_form.first_name or '' }}">
                        </div>

                        <div class="mb-3">
                            <label for="last_name" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="last_name" name="last_name" value="{{ student_form.last_name or '' }}">
                        </div>

                        <div class="mb-3">
                            <label for="date_of_birth" class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" id="date_of_birth" name="date_of_birth" value="{{ student_form.date_of_birth or '' }}">
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Submit</button>
                    </form>
                </div>

            </div>
        </div>
    </div>

    <!-- Add Class Modal -->
    <div class="modal fade" id="addClassModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Class</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{{ url_for('add_class') }}">
                        <div class="mb-3">
                            <label for="class_name" class="form-label">Class Name</label>
                            <input type="text" class="form-control" id="class_name" name="name" value="{{ class_form.name or '' }}">
                        </div>
                        <div class="mb-3">
                            <label for="year_group" class="form-label">Year Group</label>
                            <input type="text" class="form-control" id="year_group" name="year_group" value="{{ class_form.year_group or '' }}">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Submit</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    var element = document.getElementById('toast');
    element.style.display = "block";
    setTimeout(function() {
        element.style.display = "none";
    }, 3000); // 1000ms = 1 second
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            {% for class in classes %}
                const chartData{{ class.id }} = {
                    genres: [],
                    marks: {},
                    writingAges: {},
                    expectedAges: {},
                    dates: {}
                };

                {% for student in class.students %}
                    {% for sample in student.writing_samples %}
                        {% set genre = sample.assignment.genre|title if sample.assignment else 'Free Writing' %}
                        if (!chartData{{ class.id }}.genres.includes('{{ genre }}')) {
                            chartData{{ class.id }}.genres.push('{{ genre }}');
                            chartData{{ class.id }}.marks['{{ genre }}'] = [];
                            chartData{{ class.id }}.writingAges['{{ genre }}'] = [];
                            chartData{{ class.id }}.expectedAges['{{ genre }}'] = [];
                            chartData{{ class.id }}.dates['{{ genre }}'] = [];
                        }

                        {% if sample.criteria_marks %}
                            {% set mark = (sample.criteria_marks|sum(attribute='score') / (sample.criteria_marks|length * 2) * 100)|round|int %}
                            chartData{{ class.id }}.marks['{{ genre }}'].push({{ mark }});
                        {% endif %}

                        {% if sample.writing_age %}
                            {% set writing_age_parts = sample.writing_age.replace('Estimated writing age:', '').strip().split() %}
                            {% set writing_age_years = writing_age_parts[0]|float if writing_age_parts|length > 0 else 0 %}
                            {% set writing_age_months = writing_age_parts[2]|float / 12 if writing_age_parts|length > 2 else 0 %}
                            {% set calculated_writing_age = writing_age_years + writing_age_months %}
                            chartData{{ class.id }}.writingAges['{{ genre }}'].push({{ calculated_writing_age }});

                            {% set student_age = ((sample.created_at.date() - student.date_of_birth).days / 365.25)|round(1) %}
                            chartData{{ class.id }}.expectedAges['{{ genre }}'].push({{ student_age }});
                            chartData{{ class.id }}.dates['{{ genre }}'].push('{{ sample.created_at.strftime("%Y-%m-%d") }}');
                        {% endif %}
                    {% endfor %}
                {% endfor %}

                // Initialize charts
                const marksCtx{{ class.id }} = document.getElementById('marksChart{{ class.id }}').getContext('2d');
                const ageCtx{{ class.id }} = document.getElementById('ageChart{{ class.id }}').getContext('2d');

                // Calculate averages for each genre
                const dataPoints{{ class.id }} = chartData{{ class.id }}.genres.map(genre => ({
                    genre: genre,
                    avgMark: chartData{{ class.id }}.marks[genre].length > 0 
                        ? chartData{{ class.id }}.marks[genre].reduce((a, b) => a + b, 0) / chartData{{ class.id }}.marks[genre].length 
                        : 0,
                    avgWritingAge: chartData{{ class.id }}.writingAges[genre].length > 0
                        ? chartData{{ class.id }}.writingAges[genre].reduce((a, b) => a + b, 0) / chartData{{ class.id }}.writingAges[genre].length
                        : 0,
                    avgExpectedAge: chartData{{ class.id }}.expectedAges[genre].length > 0
                        ? chartData{{ class.id }}.expectedAges[genre].reduce((a, b) => a + b, 0) / chartData{{ class.id }}.expectedAges[genre].length
                        : 0
                }));

                // Marks Chart
                new Chart(marksCtx{{ class.id }}, {
                    type: 'line',
                    data: {
                        labels: dataPoints{{ class.id }}.map(d => d.genre),
                        datasets: [{
                            label: 'Average Score (%)',
                            data: dataPoints{{ class.id }}.map(d => d.avgMark),
                            backgroundColor: 'rgba(25, 135, 84, 0.2)',
                            borderColor: 'rgb(25, 135, 84)',
                            borderWidth: 2,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Score (%)'
                                }
                            }
                        }
                    }
                });

                // Age Chart
                new Chart(ageCtx{{ class.id }}, {
                    type: 'line',
                    data: {
                        labels: dataPoints{{ class.id }}.map(d => d.genre),
                        datasets: [{
                            label: 'Average Writing Age',
                            data: dataPoints{{ class.id }}.map(d => d.avgWritingAge),
                            borderColor: 'rgb(25, 135, 84)',
                            backgroundColor: 'rgba(25, 135, 84, 0.2)',
                            borderWidth: 2,
                            tension: 0.1
                        },
                        {
                            label: 'Average Student Age',
                            data: dataPoints{{ class.id }}.map(d => d.avgExpectedAge),
                            borderColor: 'rgb(13, 110, 253)',
                            backgroundColor: 'rgba(13, 110, 253, 0.2)',
                            borderWidth: 2,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'Age (Years)'
                                }
                            }
                        }
                    }
                });

                // Chart toggle functionality
                const toggleButtons{{ class.id }} = document.querySelectorAll(`[data-graph$="{{ class.id }}"]`);
                const chartCanvases{{ class.id }} = {
                    [`marks{{ class.id }}`]: document.getElementById('marksChart{{ class.id }}'),
                    [`age{{ class.id }}`]: document.getElementById('ageChart{{ class.id }}')
                };

                toggleButtons{{ class.id }}.forEach(button => {
                    button.addEventListener('click', function() {
                        const graphType = this.dataset.graph;

                        // Update buttons
                        toggleButtons{{ class.id }}.forEach(btn => btn.classList.remove('active'));
                        this.classList.add('active');

                        // Show/hide charts
                        Object.values(chartCanvases{{ class.id }}).forEach(canvas => canvas.style.display = 'none');
                        chartCanvases{{ class.id }}[graphType].style.display = 'block';
                    });
                });
            {% endfor %}
        });

        function setClassId(classId) {
            document.getElementById('studentClassId').value = classId;
        }

        function deleteClass(classId, className) {
            if (confirm(`Are you sure you want to delete the class "${className}"? This will delete all associated students and assignments.`)) {
                fetch(`/class/${classId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                }).then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to delete class');
                    }
                }).catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the class');
                });
            }
        }

        // CSV template download
        document.querySelectorAll('.download-template').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const template = 'Student ID,First Name,Last Name,Date of Birth\n22222,John,Smith,2018-09-01\n,Jane,Doe,2018-10-15';
                const blob = new Blob([template], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'students_template.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            });
        });

        function deleteStudent(studentId, studentName) {
            if (confirm(`Are you sure you want to delete ${studentName}? This will delete all their writing samples.`)) {
                fetch(`/student/${studentId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                }).then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to delete student');
                    }
                }).catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the student');
                });
            }
        }
    </script>
{% endblock %}
</body>
</html>