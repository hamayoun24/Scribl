<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Photo Capture - Scribl</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 15px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
        }
        .camera-container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .preview-container {
            text-align: center;
            margin: 15px 0;
            position: relative;
            min-height: 100px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        .preview-container.has-image {
            border: none;
        }
        .preview-container img {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
        }
        .btn-primary {
            background-color: #3E5D58;
            border-color: #3E5D58;
        }
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            min-width: 300px;
            text-align: center;
        }
        .camera-prompt {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #6c757d;
        }
        .camera-prompt i {
            font-size: 48px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="camera-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="m-0">Take Photo</h2>
                <a href="/add_writing" class="btn btn-outline-secondary btn-sm">
                    <i class="fa fa-arrow-left me-1"></i> Back
                </a>
            </div>
            
            <form id="captureForm">
                <input type="hidden" id="student-id" value="{{ student_id }}">
                <input type="hidden" id="assignment-id" value="{{ assignment_id }}">
                
                <div class="preview-container" id="preview-container">
                    <div class="camera-prompt">
                        <i class="fa fa-camera"></i>
                        <p>No image captured yet</p>
                    </div>
                </div>

                <div class="d-grid gap-2 mb-3">
                    <button type="button" class="btn btn-primary btn-lg" id="capture-btn">
                        <i class="fa fa-camera me-2"></i>Take Photo
                    </button>
                    
                    <button type="button" class="btn btn-outline-primary" id="take-another-btn" disabled>
                        <i class="fa fa-plus me-2"></i>Take Another Photo
                    </button>
                </div>
                
                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-success btn-lg" id="submit-btn" disabled>
                        <i class="fa fa-check me-2"></i>Process Images
                    </button>
                </div>
            </form>
            
            <div class="text-center mt-4">
                <p class="mb-0"><small class="text-muted">Captured Photos: <span id="image-count">0</span></small></p>
            </div>
        </div>
    </div>
    
    <!-- Completely hidden file input -->
    <input type="file" 
           accept="image/*" 
           capture="environment"
           id="camera-input" 
           style="position: absolute; width: 1px; height: 1px; overflow: hidden; opacity: 0;">

    <!-- Notification container -->
    <div id="notification-container"></div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Cache DOM elements
        const form = document.getElementById('captureForm');
        const captureBtn = document.getElementById('capture-btn');
        const takeAnotherBtn = document.getElementById('take-another-btn');
        const submitBtn = document.getElementById('submit-btn');
        const previewContainer = document.getElementById('preview-container');
        const imageCountElement = document.getElementById('image-count');
        const cameraInput = document.getElementById('camera-input');
        const studentIdInput = document.getElementById('student-id');
        const assignmentIdInput = document.getElementById('assignment-id');
        
        // State
        let capturedImages = [];
        let currentImageIndex = 0;
        
        // Helper functions
        function showNotification(message, type = 'success') {
            console.log(`Notification (${type}):`, message);
            
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} notification`;
            notification.innerHTML = message;
            
            document.getElementById('notification-container').appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
        
        function updateUI() {
            // Update image count
            imageCountElement.textContent = capturedImages.length;
            
            // Update buttons
            submitBtn.disabled = capturedImages.length === 0;
            takeAnotherBtn.disabled = capturedImages.length === 0;
            
            // Update preview container
            if (capturedImages.length > 0) {
                previewContainer.innerHTML = '';
                previewContainer.classList.add('has-image');
                
                const img = document.createElement('img');
                img.src = capturedImages[currentImageIndex].url;
                previewContainer.appendChild(img);
                
                // Only show navigation if more than one image
                if (capturedImages.length > 1) {
                    const navDiv = document.createElement('div');
                    navDiv.className = 'position-absolute bottom-0 start-0 end-0 d-flex justify-content-between p-2';
                    
                    const prevBtn = document.createElement('button');
                    prevBtn.className = 'btn btn-sm btn-light';
                    prevBtn.innerHTML = '<i class="fa fa-chevron-left"></i>';
                    prevBtn.disabled = currentImageIndex === 0;
                    prevBtn.addEventListener('click', () => {
                        currentImageIndex = Math.max(0, currentImageIndex - 1);
                        updateUI();
                    });
                    
                    const nextBtn = document.createElement('button');
                    nextBtn.className = 'btn btn-sm btn-light';
                    nextBtn.innerHTML = '<i class="fa fa-chevron-right"></i>';
                    nextBtn.disabled = currentImageIndex === capturedImages.length - 1;
                    nextBtn.addEventListener('click', () => {
                        currentImageIndex = Math.min(capturedImages.length - 1, currentImageIndex + 1);
                        updateUI();
                    });
                    
                    const indicator = document.createElement('div');
                    indicator.className = 'badge bg-primary';
                    indicator.textContent = `${currentImageIndex + 1}/${capturedImages.length}`;
                    
                    navDiv.appendChild(prevBtn);
                    navDiv.appendChild(indicator);
                    navDiv.appendChild(nextBtn);
                    
                    previewContainer.appendChild(navDiv);
                }
            } else {
                previewContainer.innerHTML = `
                    <div class="camera-prompt">
                        <i class="fa fa-camera"></i>
                        <p>No image captured yet</p>
                    </div>
                `;
                previewContainer.classList.remove('has-image');
            }
        }
        
        function activateCamera() {
            console.log('Activating camera');
            
            // Reset input to ensure change event fires
            cameraInput.value = '';
            
            // Use a slight timeout before triggering camera
            setTimeout(() => {
                try {
                    cameraInput.click();
                    console.log('Camera activated');
                } catch (error) {
                    console.error('Error activating camera:', error);
                    showNotification('Error opening camera. Please try again.', 'danger');
                }
            }, 100);
        }
        
        // Event Listeners
        captureBtn.addEventListener('click', activateCamera);
        
        takeAnotherBtn.addEventListener('click', activateCamera);
        
        cameraInput.addEventListener('change', (event) => {
            if (event.target.files && event.target.files.length > 0) {
                console.log('Images captured:', event.target.files.length);
                
                Array.from(event.target.files).forEach(file => {
                    try {
                        console.log('Processing file:', file.name);
                        const imageUrl = URL.createObjectURL(file);
                        
                        capturedImages.push({
                            file: file,
                            url: imageUrl
                        });
                        
                        console.log('Image processed and stored');
                    } catch (error) {
                        console.error('Error processing image:', error);
                    }
                });
                
                // Update index to show latest image
                currentImageIndex = capturedImages.length - 1;
                
                // Update UI
                updateUI();
                
                // Show success notification
                showNotification('Image captured successfully!');
            }
        });
        
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            if (capturedImages.length === 0) {
                showNotification('Please take at least one photo.', 'warning');
                return;
            }
            
            // Prepare form data
            const formData = new FormData();
            
            // Add all images
            capturedImages.forEach(img => {
                formData.append('image', img.file);
            });
            
            // Add student and assignment IDs if available
            if (studentIdInput.value) {
                formData.append('student_id', studentIdInput.value);
            }
            
            if (assignmentIdInput.value) {
                formData.append('assignment_id', assignmentIdInput.value);
            }
            
            // Show processing state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Processing...';
            
            try {
                // Send data to server
                const response = await fetch('/process_image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification('Images processed successfully!');
                    // Redirect to the writing page after processing
                    window.location.href = `/writing/${result.writing_id}`;
                } else {
                    showNotification(result.error || 'Failed to process images.', 'danger');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fa fa-check me-2"></i>Process Images';
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                showNotification('An error occurred while processing images.', 'danger');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa fa-check me-2"></i>Process Images';
            }
        });
        
        // Auto-activate camera on mobile devices
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            console.log('Mobile device detected - auto-activating camera');
            setTimeout(activateCamera, 500);
        }
    });
    </script>
</body>
</html>